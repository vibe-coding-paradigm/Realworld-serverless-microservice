#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ” Running pre-commit checks..."

# Backend checks
echo "ğŸ¹ Checking Go code..."
if [ -d "backend" ]; then
  cd backend
  
  # Check Go formatting
  echo "  ğŸ“ Checking Go formatting..."
  if ! gofmt -l . | grep -v vendor/ | grep .; then
    echo "  âœ… Go formatting check passed"
  else
    echo "  âŒ Go formatting issues found. Run 'gofmt -w .' to fix"
    exit 1
  fi
  
  # Run Go linter if available
  if command -v golangci-lint >/dev/null 2>&1; then
    echo "  ğŸ” Running golangci-lint..."
    if golangci-lint run; then
      echo "  âœ… Go linting passed"
    else
      echo "  âŒ Go linting failed"
      exit 1
    fi
  else
    echo "  âš ï¸  golangci-lint not found, skipping linting"
  fi
  
  # Run Go tests
  echo "  ğŸ§ª Running Go tests..."
  if go test ./...; then
    echo "  âœ… Go tests passed"
  else
    echo "  âŒ Go tests failed"
    exit 1
  fi
  
  cd ..
fi

# Frontend checks
echo "ğŸŒ Checking frontend code..."
if [ -d "frontend" ]; then
  cd frontend
  
  # Run ESLint
  echo "  ğŸ” Running ESLint..."
  if npm run lint; then
    echo "  âœ… ESLint check passed"
  else
    echo "  âŒ ESLint check failed"
    exit 1
  fi
  
  # Check TypeScript compilation
  echo "  ğŸ“˜ Checking TypeScript compilation..."
  if npx tsc --noEmit; then
    echo "  âœ… TypeScript check passed"
  else
    echo "  âŒ TypeScript check failed"
    exit 1
  fi
  
  # Run frontend tests
  echo "  ğŸ§ª Running frontend tests..."
  if npm test -- --run; then
    echo "  âœ… Frontend tests passed"
  else
    echo "  âŒ Frontend tests failed"
    exit 1
  fi
  
  cd ..
fi

echo "âœ… All pre-commit checks passed!"