#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ” Running pre-commit checks..."

# Backend checks
echo "ğŸ¹ Checking Go code..."
if [ -d "backend" ]; then
  cd backend
  
  # Check Go formatting
  echo "  ğŸ“ Checking Go formatting..."
  if ! gofmt -l . | grep -v vendor/ | grep .; then
    echo "  âœ… Go formatting check passed"
  else
    echo "  âŒ Go formatting issues found. Run 'gofmt -w .' to fix"
    exit 1
  fi
  
  # Run Go linter if available
  if command -v golangci-lint >/dev/null 2>&1; then
    echo "  ğŸ” Running golangci-lint..."
    if golangci-lint run; then
      echo "  âœ… Go linting passed"
    else
      echo "  âŒ Go linting failed"
      exit 1
    fi
  else
    echo "  âš ï¸  golangci-lint not found, skipping linting"
  fi
  
  # Run Go tests
  echo "  ğŸ§ª Running Go tests..."
  if go test ./...; then
    echo "  âœ… Go tests passed"
  else
    echo "  âŒ Go tests failed"
    exit 1
  fi
  
  cd ..
fi

# Frontend checks
echo "ğŸŒ Checking frontend code..."
if [ -d "frontend" ]; then
  cd frontend
  
  # Run ESLint
  echo "  ğŸ” Running ESLint..."
  if npm run lint; then
    echo "  âœ… ESLint check passed"
  else
    echo "  âŒ ESLint check failed"
    exit 1
  fi
  
  # Check TypeScript compilation
  echo "  ğŸ“˜ Checking TypeScript compilation..."
  if npx tsc --noEmit; then
    echo "  âœ… TypeScript check passed"
  else
    echo "  âŒ TypeScript check failed"
    exit 1
  fi
  
  # Run frontend tests
  echo "  ğŸ§ª Running frontend tests..."
  if npm test -- --run; then
    echo "  âœ… Frontend tests passed"
  else
    echo "  âŒ Frontend tests failed"
    exit 1
  fi
  
  cd ..
fi

# Infrastructure and Lambda functions checks
echo "ğŸ—ï¸ Checking infrastructure and Lambda functions..."
if [ -d "infra" ]; then
  cd infra
  
  # Install dependencies if needed
  if [ ! -d "node_modules" ]; then
    echo "  ğŸ“¦ Installing CDK dependencies..."
    npm ci
  fi
  
  # CDK synth check (validates CDK code)
  echo "  ğŸ“„ Validating CDK templates..."
  if npx cdk synth --quiet >/dev/null 2>&1; then
    echo "  âœ… CDK templates are valid"
  else
    echo "  âŒ CDK templates have errors"
    echo "  ğŸ”§ Run 'cd infra && npx cdk synth' to see details"
    exit 1
  fi
  
  # Run infrastructure tests if they exist
  if [ -f "package.json" ] && grep -q '"test"' package.json; then
    echo "  ğŸ§ª Running infrastructure tests..."
    if npm test; then
      echo "  âœ… Infrastructure tests passed"
    else
      echo "  âŒ Infrastructure tests failed"
      exit 1
    fi
  else
    echo "  âš ï¸  No infrastructure tests found, skipping..."
  fi
  
  cd ..
fi

# Lambda functions unit tests
echo "ğŸ”¥ Checking Lambda functions..."

# Check Auth Lambda functions
if [ -d "infra/lambda-functions/auth" ]; then
  echo "  ğŸ” Testing Auth Lambda functions..."
  cd infra/lambda-functions/auth
  
  # Check Go formatting
  echo "    ğŸ“ Checking Go formatting..."
  if ! gofmt -l . | grep .; then
    echo "    âœ… Auth Lambda formatting check passed"
  else
    echo "    âŒ Auth Lambda formatting issues found"
    gofmt -l .
    echo "    ğŸ”§ Run 'gofmt -w .' in infra/lambda-functions/auth to fix"
    exit 1
  fi
  
  # Ensure go.mod exists and is tidy
  if [ -f "go.mod" ]; then
    echo "    ğŸ“¦ Checking go.mod..."
    if go mod tidy && git diff --exit-code go.mod go.sum >/dev/null 2>&1; then
      echo "    âœ… go.mod is tidy"
    else
      echo "    âŒ go.mod needs tidying"
      echo "    ğŸ”§ Run 'go mod tidy' in infra/lambda-functions/auth"
      exit 1
    fi
  fi
  
  # Run Go tests for auth functions
  echo "    ğŸ§ª Running Auth Lambda tests..."
  if go test ./...; then
    echo "    âœ… Auth Lambda tests passed"
  else
    echo "    âŒ Auth Lambda tests failed"
    exit 1
  fi
  
  # Test build
  echo "    ğŸ”¨ Testing Auth Lambda build..."
  if GOOS=linux GOARCH=amd64 go build -o /tmp/test-register register.go && \
     GOOS=linux GOARCH=amd64 go build -o /tmp/test-login login.go && \
     GOOS=linux GOARCH=amd64 go build -o /tmp/test-getuser getuser.go; then
    echo "    âœ… Auth Lambda functions build successfully"
    rm -f /tmp/test-register /tmp/test-login /tmp/test-getuser
  else
    echo "    âŒ Auth Lambda functions build failed"
    exit 1
  fi
  
  cd ../../..
fi

# Check Articles Lambda functions
if [ -d "infra/lambda-functions/articles" ]; then
  echo "  ğŸ“ Testing Articles Lambda functions..."
  cd infra/lambda-functions/articles
  
  # Check Go formatting
  echo "    ğŸ“ Checking Go formatting..."
  if ! gofmt -l . | grep .; then
    echo "    âœ… Articles Lambda formatting check passed"
  else
    echo "    âŒ Articles Lambda formatting issues found"
    gofmt -l .
    echo "    ğŸ”§ Run 'gofmt -w .' in infra/lambda-functions/articles to fix"
    exit 1
  fi
  
  # Ensure go.mod exists and is tidy
  if [ -f "go.mod" ]; then
    echo "    ğŸ“¦ Checking go.mod..."
    if go mod tidy && git diff --exit-code go.mod go.sum >/dev/null 2>&1; then
      echo "    âœ… go.mod is tidy"
    else
      echo "    âŒ go.mod needs tidying"
      echo "    ğŸ”§ Run 'go mod tidy' in infra/lambda-functions/articles"
      exit 1
    fi
  fi
  
  # Run Go tests for articles functions
  echo "    ğŸ§ª Running Articles Lambda tests..."
  if go test ./...; then
    echo "    âœ… Articles Lambda tests passed"
  else
    echo "    âŒ Articles Lambda tests failed"
    exit 1
  fi
  
  # Test build
  echo "    ğŸ”¨ Testing Articles Lambda build..."
  if GOOS=linux GOARCH=amd64 go build -o /tmp/test-list list_articles.go && \
     GOOS=linux GOARCH=amd64 go build -o /tmp/test-get get_article.go && \
     GOOS=linux GOARCH=amd64 go build -o /tmp/test-create create_article.go && \
     GOOS=linux GOARCH=amd64 go build -o /tmp/test-update update_article.go && \
     GOOS=linux GOARCH=amd64 go build -o /tmp/test-delete delete_article.go && \
     GOOS=linux GOARCH=amd64 go build -o /tmp/test-favorite favorite_article.go; then
    echo "    âœ… Articles Lambda functions build successfully"
    rm -f /tmp/test-list /tmp/test-get /tmp/test-create /tmp/test-update /tmp/test-delete /tmp/test-favorite
  else
    echo "    âŒ Articles Lambda functions build failed"
    exit 1
  fi
  
  cd ../../..
fi

# Check Comments Lambda functions
if [ -d "infra/lambda-functions/comments" ]; then
  echo "  ğŸ’¬ Testing Comments Lambda functions..."
  cd infra/lambda-functions/comments
  
  # Check Go formatting
  echo "    ğŸ“ Checking Go formatting..."
  if ! gofmt -l . | grep .; then
    echo "    âœ… Comments Lambda formatting check passed"
  else
    echo "    âŒ Comments Lambda formatting issues found"
    gofmt -l .
    echo "    ğŸ”§ Run 'gofmt -w .' in infra/lambda-functions/comments to fix"
    exit 1
  fi
  
  # Ensure go.mod exists and is tidy
  if [ -f "go.mod" ]; then
    echo "    ğŸ“¦ Checking go.mod..."
    if go mod tidy && git diff --exit-code go.mod go.sum >/dev/null 2>&1; then
      echo "    âœ… go.mod is tidy"
    else
      echo "    âŒ go.mod needs tidying"
      echo "    ğŸ”§ Run 'go mod tidy' in infra/lambda-functions/comments"
      exit 1
    fi
  fi
  
  # Run Go tests for comments functions
  echo "    ğŸ§ª Running Comments Lambda tests..."
  if go test ./...; then
    echo "    âœ… Comments Lambda tests passed"
  else
    echo "    âŒ Comments Lambda tests failed"
    exit 1
  fi
  
  # Test build
  echo "    ğŸ”¨ Testing Comments Lambda build..."
  if GOOS=linux GOARCH=amd64 go build -o /tmp/test-list-comments list_comments.go && \
     GOOS=linux GOARCH=amd64 go build -o /tmp/test-create-comment create_comment.go && \
     GOOS=linux GOARCH=amd64 go build -o /tmp/test-delete-comment delete_comment.go; then
    echo "    âœ… Comments Lambda functions build successfully"
    rm -f /tmp/test-list-comments /tmp/test-create-comment /tmp/test-delete-comment
  else
    echo "    âŒ Comments Lambda functions build failed"
    exit 1
  fi
  
  cd ../../..
fi

echo "âœ… All pre-commit checks passed!"
echo "ğŸ“‹ Summary:"
echo "  âœ… Backend code (Go) - formatting, linting, tests"
echo "  âœ… Frontend code (TypeScript/React) - linting, compilation, tests"
echo "  âœ… Infrastructure (CDK) - template validation, tests"
echo "  âœ… Lambda functions (Go) - formatting, tests, build verification"