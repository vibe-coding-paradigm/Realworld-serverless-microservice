#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "🚀 Running pre-push checks (E2E tests)..."

# Run E2E tests using Makefile command
echo "🔍 Running E2E tests..."
if make e2e; then
    echo "✅ E2E tests passed!"
    echo ""
    echo "🔧 Running additional quality checks..."
    
    # Optional: Run load tests with timeout (non-blocking)
    if command -v k6 >/dev/null 2>&1; then
        echo "📊 Running quick load test (30s timeout)..."
        if timeout 30s make load-test-local > /dev/null 2>&1; then
            echo "✅ Load test passed!"
        else
            echo "⚠️  Load test failed or timed out, but push allowed"
            echo "💡 Run 'make load-test-local' manually to investigate"
        fi
    else
        echo "⚠️  k6 not installed, skipping load test"
        echo "💡 Install k6 for load testing: brew install k6"
    fi
    
    echo ""
    echo "✅ All pre-push checks passed!"
    echo "🚀 Push allowed - E2E tests confirmed deployment readiness"
else
    echo ""
    echo "❌ E2E tests failed!"
    echo "🚫 Push blocked - fix failing E2E tests before pushing"
    echo ""
    echo "🔧 Debugging tips:"
    echo "   • Check if backend is running: make dev-status"
    echo "   • Run E2E tests manually: make e2e"
    echo "   • View detailed logs: make e2e-debug"
    echo "   • Reset environment: make reset-env"
    echo ""
    exit 1
fi