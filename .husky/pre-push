#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸš€ Running pre-push checks (Serverless E2E tests)..."

# Check if AWS credentials are configured
echo "ğŸ” AWS ìê²© ì¦ëª… í™•ì¸ ì¤‘..."
if ! aws sts get-caller-identity >/dev/null 2>&1; then
    echo "âŒ AWS ìê²© ì¦ëª…ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"
    echo "ğŸ”§ ë‹¤ìŒ ì¤‘ í•˜ë‚˜ë¥¼ ìˆ˜í–‰í•˜ì„¸ìš”:"
    echo "   â€¢ aws configure ì‹¤í–‰"
    echo "   â€¢ AWS_PROFILE í™˜ê²½ë³€ìˆ˜ ì„¤ì •"
    echo "   â€¢ AWS SSO ë¡œê·¸ì¸: aws sso login"
    echo ""
    exit 1
fi

echo "âœ… AWS ìê²© ì¦ëª… í™•ì¸ ì™„ë£Œ"

# Check if CDK is bootstrapped and ready
echo "ğŸ—ï¸ CDK í™˜ê²½ í™•ì¸ ì¤‘..."
if ! cd infra && npx cdk ls >/dev/null 2>&1; then
    echo "âŒ CDK í™˜ê²½ ì„¤ì •ì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤"
    echo "ğŸ”§ ë‹¤ìŒì„ ì‹œë„í•´ë³´ì„¸ìš”:"
    echo "   â€¢ cd infra && npm install"
    echo "   â€¢ npx cdk bootstrap"
    echo ""
    exit 1
fi

echo "âœ… CDK í™˜ê²½ í™•ì¸ ì™„ë£Œ"

# Deploy and run E2E tests in cloud environment
echo "ğŸ” ì„œë²„ë¦¬ìŠ¤ ë°°í¬ ë° í´ë¼ìš°ë“œ E2E í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
if make e2e-serverless; then
    echo "âœ… ì„œë²„ë¦¬ìŠ¤ E2E í…ŒìŠ¤íŠ¸ ì„±ê³µ!"
    echo ""
    echo "âœ… All pre-push checks passed!"
    echo "ğŸš€ Push allowed - Serverless deployment and E2E tests confirmed readiness"
else
    echo ""
    echo "âŒ ì„œë²„ë¦¬ìŠ¤ E2E í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨!"
    echo "ğŸš« Push blocked - fix failing serverless deployment or E2E tests"
    echo ""
    echo "ğŸ”§ Debugging tips:"
    echo "   â€¢ Check AWS deployment status: make deploy-check"
    echo "   â€¢ View CDK deployment logs: cd infra && npx cdk deploy --verbose"
    echo "   â€¢ Run cloud E2E tests manually: make e2e-cloud"
    echo "   â€¢ Check AWS resources: make verify-deployment"
    echo "   â€¢ View comprehensive debug info: make debug"
    echo ""
    exit 1
fi