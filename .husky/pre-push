#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸš€ Running pre-push checks (E2E tests)..."

# Run E2E tests using Makefile command
echo "ğŸ” Running E2E tests..."
if make e2e; then
    echo "âœ… E2E tests passed!"
    echo ""
    echo "ğŸ”§ Running additional quality checks..."
    
    # Optional: Run load tests with timeout (non-blocking)
    if command -v k6 >/dev/null 2>&1; then
        echo "ğŸ“Š Running quick load test (30s timeout)..."
        if timeout 30s make load-test-local > /dev/null 2>&1; then
            echo "âœ… Load test passed!"
        else
            echo "âš ï¸  Load test failed or timed out, but push allowed"
            echo "ğŸ’¡ Run 'make load-test-local' manually to investigate"
        fi
    else
        echo "âš ï¸  k6 not installed, skipping load test"
        echo "ğŸ’¡ Install k6 for load testing: brew install k6"
    fi
    
    echo ""
    echo "âœ… All pre-push checks passed!"
    echo "ğŸš€ Push allowed - E2E tests confirmed deployment readiness"
else
    echo ""
    echo "âŒ E2E tests failed!"
    echo "ğŸš« Push blocked - fix failing E2E tests before pushing"
    echo ""
    echo "ğŸ”§ Debugging tips:"
    echo "   â€¢ Check if backend is running: make dev-status"
    echo "   â€¢ Run E2E tests manually: make e2e"
    echo "   â€¢ View detailed logs: make e2e-debug"
    echo "   â€¢ Reset environment: make reset-env"
    echo ""
    exit 1
fi